import {useMemo,useRef,useCallback,useSyncExternalStore}from'react';import {generateCacheKey,buildConfig,getCache,getInFlightPromise,fetchf,getCachedResponse,subscribe,addTimeout,abortRequest,deleteCache}from'fetchff';var p=-1,E=2e3,m=new Map,q=e=>{e&&m.set(e,(m.get(e)||0)+1);},A=(e,t,r,n)=>{if(!e)return;let a=R(e);if(!a)return;let h=a-1;h<=0?(m.delete(e),t===p&&addTimeout("r:"+e,()=>{abortRequest(e,new DOMException("Request to "+n+" aborted","AbortError")),R(e)||deleteCache(e,true);},r!=null?r:E)):m.set(e,h);},R=e=>e&&m.get(e)||0;var X=300,K=Object.freeze({data:null,error:null,isFetching:false,mutate:()=>Promise.resolve(null),config:{},headers:{}}),S=Object.freeze({...K,isFetching:true}),Y=[null,{},null],Z=new Set(["GET","HEAD","get","head"]);function se(e,t={}){var T,b,U;let r=useMemo(()=>e===null?null:generateCacheKey(buildConfig(e,t)),[t.cacheKey,e,t.url,t.method,t.headers,t.body,t.params,t.urlPathParams,t.apiUrl,t.baseURL,t.withCredentials,t.credentials]),n=(T=t.dedupeTime)!=null?T:E,a=t.cacheTime||p,h=(b=t.staleTime)!=null?b:X,d=(U=t.immediate)!=null?U:Z.has(t.method||"GET"),f=useRef(Y);f.current=[e,t,r];let F=useCallback(()=>{let s=getCache(r);if(t.strategy==="reject"&&r&&(!s||!s.data.data&&!s.data.error)){let l=getInFlightPromise(r,n);if(l)throw l;if(!s){let[u,o,i]=f.current;if(u)throw fetchf(u,{...o,cacheKey:i,dedupeTime:n,cacheTime:a,staleTime:h,strategy:"softFail",cacheErrors:true,_isAutoKey:!o.cacheKey})}}return s?s.data.isFetching&&!t.keepPreviousData?S:s.data:d?S:K},[r]),x=useCallback(s=>{q(r),d&&e&&r&&R(r)===1&&(getCachedResponse(r,a,t)||y(false));let u=subscribe(r,s);return ()=>{A(r,a,n,e),u();}},[r,d,e,n,a]),c=useSyncExternalStore(x,F,F),y=useCallback(async(s=true,l={})=>{let[u,o,i]=f.current;if(!u)return Promise.resolve(null);let P=!!s;if(!P&&i){let _=getCachedResponse(i,a,o);if(_)return Promise.resolve(_)}let w=P?()=>true:o.cacheBuster;return fetchf(u,{...o,cacheKey:i,...l,dedupeTime:n,cacheTime:a,staleTime:h,cacheBuster:w,strategy:"softFail",cacheErrors:true,_isAutoKey:!o.cacheKey})},[a,n]),C=c.data,B=!C&&!c.error,g=c.isFetching,L=!!e&&(g||B&&d);return {data:C,error:c.error,config:c.config,headers:c.headers,isFetching:g,isLoading:L,mutate:c.mutate,refetch:y}}export{se as useFetcher};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map